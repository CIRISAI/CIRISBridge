# Deploy CIRISBilling
---
- name: Copy Billing docker-compose
  ansible.builtin.template:
    src: docker-compose.yml.j2
    dest: /opt/ciris/billing/docker-compose.yml
    mode: "0644"

- name: Copy Billing environment file
  ansible.builtin.template:
    src: env.j2
    dest: /opt/ciris/billing/.env
    mode: "0600"
  notify: Restart Billing

- name: Create Billing log directory
  ansible.builtin.file:
    path: /var/log/ciris/billing
    state: directory
    mode: "0755"

- name: Start Billing service
  community.docker.docker_compose_v2:
    project_src: /opt/ciris/billing
    state: present
    pull: always

- name: Wait for Billing to be ready
  ansible.builtin.uri:
    url: "http://localhost:{{ billing_port }}/health"
    status_code: 200
  register: result
  retries: 15
  delay: 5
  until: result.status == 200

- name: Run database migrations (US node only to avoid conflicts)
  community.docker.docker_container_exec:
    container: ciris-billing
    command: alembic upgrade head
  when: node_name == "us"
