# Caddy Configuration - Auto-generated by Ansible
# TLS termination for CIRISBridge services

{
    email {{ caddy_email }}
    acme_ca https://acme-v02.api.letsencrypt.org/directory
}

# Billing API
billing1.{{ dns_soa }} {
    reverse_proxy ciris-billing:{{ billing_port }} {
        health_uri /health
        health_interval 30s
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        -Server
    }

    log {
        output file /var/log/caddy/billing.log
        format json
    }
}

# LLM Proxy
proxy1.{{ dns_soa }} {
    reverse_proxy ciris-proxy:{{ proxy_port }} {
        health_uri /health
        health_interval 30s
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        -Server
    }

    log {
        output file /var/log/caddy/proxy.log
        format json
    }
}

# Agents endpoint (same as billing for now)
agents.{{ dns_soa }} {
    reverse_proxy ciris-billing:{{ billing_port }} {
        health_uri /health
        health_interval 30s
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        X-Frame-Options DENY
        -Server
    }
}

# CIRISLens - Observability (US node only)
lens.{{ dns_soa }} {
    # API routes (log ingestion, admin)
    handle /api/* {
        reverse_proxy cirislens-api:8000
    }

    # Grafana dashboards (default)
    handle {
        reverse_proxy cirislens-grafana:3000
    }

    header {
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        X-Content-Type-Options nosniff
        -Server
    }

    log {
        output file /var/log/caddy/lens.log
        format json
    }
}

# Root domain - redirect to docs or landing page
{{ dns_soa }} {
    respond "CIRIS Infrastructure - {{ dns_soa }}" 200
}
