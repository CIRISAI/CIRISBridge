# Grafana Alerting Configuration for CIRISLens
# Alert rules for monitoring service errors

apiVersion: 1

groups:
  - orgId: 1
    name: CIRIS Service Alerts
    folder: CIRIS Alerts
    interval: 1m
    rules:
      # Alert when any service has errors in the last 5 minutes
      - uid: service-errors-alert
        title: Service Errors Detected
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: postgresql
            model:
              rawSql: |
                SELECT
                  NOW() as time,
                  COUNT(*) as value
                FROM cirislens.service_logs
                WHERE level IN ('ERROR', 'CRITICAL')
                  AND timestamp > NOW() - INTERVAL '5 minutes'
                  AND message NOT LIKE '%play_integrity%'
                  AND message NOT LIKE '%playintegrity%'
                  AND message NOT LIKE '%RateLimitError%'
                  AND COALESCE(event, '') NOT LIKE '%play_integrity%'
              format: table
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: []
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - B
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - C
                  reducer:
                    params: []
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 0s
        annotations:
          summary: "Service errors detected in CIRIS infrastructure"
          description: "One or more CIRIS services have logged ERROR or CRITICAL level messages in the last 5 minutes (excludes Play Integrity and rate limit errors)."
          runbook_url: "https://lens.ciris-services-1.ai/d/error-correlation/error-correlation"
        labels:
          severity: warning
        isPaused: false

      # Alert when error rate is high (5+ errors in 5 minutes)
      - uid: high-error-rate-alert
        title: High Error Rate
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: postgresql
            model:
              rawSql: |
                SELECT
                  NOW() as time,
                  COUNT(*) as value
                FROM cirislens.service_logs
                WHERE level IN ('ERROR', 'CRITICAL')
                  AND timestamp > NOW() - INTERVAL '5 minutes'
                  AND message NOT LIKE '%play_integrity%'
                  AND message NOT LIKE '%playintegrity%'
                  AND message NOT LIKE '%RateLimitError%'
                  AND COALESCE(event, '') NOT LIKE '%play_integrity%'
              format: table
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 5
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 0s
        annotations:
          summary: "High error rate detected"
          description: "More than 5 errors detected in the last 5 minutes across CIRIS services (excludes Play Integrity and rate limit errors)."
          runbook_url: "https://lens.ciris-services-1.ai/d/error-correlation/error-correlation"
        labels:
          severity: critical
        isPaused: false

      # Alert when scheduler heartbeat is missing from US node
      - uid: heartbeat-missing-us-alert
        title: Scheduler Heartbeat Missing (US)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: postgresql
            model:
              rawSql: |
                SELECT
                  NOW() as time,
                  COUNT(*) as value
                FROM cirislens.service_logs
                WHERE service_name = 'ciris-scheduler'
                  AND event = 'heartbeat'
                  AND server_id = 'us'
                  AND timestamp > NOW() - INTERVAL '10 minutes'
              format: table
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: lt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "Scheduler heartbeat missing from US node"
          description: "The US node (Vultr) has sent fewer than 2 heartbeats in the last 10 minutes. Expected heartbeat every 5 minutes. Node may be down or scheduler service is failing."
          runbook_url: "https://lens.ciris-services-1.ai/d/service-logs/service-logs"
        labels:
          severity: critical
          node: us
        isPaused: false

      # Alert when scheduler heartbeat is missing from EU node
      - uid: heartbeat-missing-eu-alert
        title: Scheduler Heartbeat Missing (EU)
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: postgresql
            model:
              rawSql: |
                SELECT
                  NOW() as time,
                  COUNT(*) as value
                FROM cirislens.service_logs
                WHERE service_name = 'ciris-scheduler'
                  AND event = 'heartbeat'
                  AND server_id = 'eu'
                  AND timestamp > NOW() - INTERVAL '10 minutes'
              format: table
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 2
                    type: lt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: Alerting
        execErrState: Alerting
        for: 0s
        annotations:
          summary: "Scheduler heartbeat missing from EU node"
          description: "The EU node (Hetzner) has sent fewer than 2 heartbeats in the last 10 minutes. Expected heartbeat every 5 minutes. Node may be down or scheduler service is failing."
          runbook_url: "https://lens.ciris-services-1.ai/d/service-logs/service-logs"
        labels:
          severity: critical
          node: eu
        isPaused: false

      # Alert when a specific service has errors
      - uid: billing-errors-alert
        title: Billing Service Errors
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: postgresql
            model:
              rawSql: |
                SELECT
                  NOW() as time,
                  COUNT(*) as value
                FROM cirislens.service_logs
                WHERE service_name = 'cirisbilling'
                  AND level IN ('ERROR', 'CRITICAL')
                  AND timestamp > NOW() - INTERVAL '5 minutes'
                  AND message NOT LIKE '%play_integrity%'
                  AND message NOT LIKE '%playintegrity%'
                  AND message NOT LIKE '%RateLimitError%'
                  AND COALESCE(event, '') NOT LIKE '%play_integrity%'
              format: table
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 0
                    type: gt
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              type: threshold
        noDataState: NoData
        execErrState: Error
        for: 0s
        annotations:
          summary: "Billing service errors detected"
          description: "The billing service (cirisbilling) has logged errors. This may affect payment processing."
          runbook_url: "https://lens.ciris-services-1.ai/d/billing-analytics/billing-analytics"
        labels:
          severity: critical
          service: billing
        isPaused: false
