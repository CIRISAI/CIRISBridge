# CIRISLens - Observability Platform
# Auto-generated by Ansible
#
# Components:
# - TimescaleDB: Time-series storage with compression
# - Grafana: Visualization dashboards
# - CIRISLens API: Log ingestion + admin UI

services:
  # ==========================================================================
  # TimescaleDB - Time-series storage
  # ==========================================================================
  postgres:
    image: timescale/timescaledb:latest-pg15
    container_name: cirislens-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: {{ lens_db_user | default('cirislens') }}
      POSTGRES_PASSWORD: {{ lens_db_password }}
      POSTGRES_DB: {{ lens_db_name | default('cirislens') }}
    volumes:
      - /data/cirislens/postgres:/var/lib/postgresql/data
      - ./sql:/docker-entrypoint-initdb.d:ro
    networks:
      - cirislens
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U {{ lens_db_user | default('cirislens') }}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================================================
  # Grafana - Visualization
  # ==========================================================================
  grafana:
    image: grafana/grafana:{{ lens_grafana_version | default('latest') }}
    container_name: cirislens-grafana
    restart: unless-stopped
    environment:
      # Admin credentials
      GF_SECURITY_ADMIN_USER: {{ lens_grafana_admin_user | default('admin') }}
      GF_SECURITY_ADMIN_PASSWORD: {{ lens_grafana_admin_password }}
      GF_SECURITY_SECRET_KEY: {{ lens_grafana_secret_key }}
      # Server configuration
      GF_SERVER_ROOT_URL: https://lens.{{ primary_domain }}
      GF_SERVER_DOMAIN: lens.{{ primary_domain }}
      # Database (use TimescaleDB instead of SQLite)
      GF_DATABASE_TYPE: postgres
      GF_DATABASE_HOST: postgres:5432
      GF_DATABASE_NAME: grafana
      GF_DATABASE_USER: {{ lens_db_user | default('cirislens') }}
      GF_DATABASE_PASSWORD: {{ lens_db_password }}
      GF_DATABASE_SSL_MODE: disable
      # Authentication
      GF_AUTH_ANONYMOUS_ENABLED: {{ 'true' if lens_public_dashboards | default(false) else 'false' }}
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      GF_AUTH_DISABLE_LOGIN_FORM: false
{% if lens_google_oauth_enabled | default(false) %}
      # Google OAuth
      GF_AUTH_GOOGLE_ENABLED: true
      GF_AUTH_GOOGLE_CLIENT_ID: {{ google_client_id }}
      GF_AUTH_GOOGLE_CLIENT_SECRET: {{ google_client_secret }}
      GF_AUTH_GOOGLE_SCOPES: openid email profile
      GF_AUTH_GOOGLE_AUTH_URL: https://accounts.google.com/o/oauth2/auth
      GF_AUTH_GOOGLE_TOKEN_URL: https://oauth2.googleapis.com/token
      GF_AUTH_GOOGLE_ALLOWED_DOMAINS: {{ lens_allowed_domain | default('ciris.ai') }}
      GF_AUTH_GOOGLE_ALLOW_SIGN_UP: true
{% endif %}
      # Features
      GF_FEATURE_TOGGLES_ENABLE: traceToMetrics,traceToLogs,correlations
      GF_EXPLORE_ENABLED: true
      GF_UNIFIED_ALERTING_ENABLED: true
    volumes:
      - /data/cirislens/grafana:/var/lib/grafana
      - ./config/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./dashboards:/var/lib/grafana/dashboards:ro
    ports:
      - "127.0.0.1:3001:3000"
    networks:
      - cirislens
      - ciris
    depends_on:
      postgres:
        condition: service_healthy

  # ==========================================================================
  # CIRISLens API - Log ingestion + Admin UI
  # ==========================================================================
  api:
    image: {{ lens_api_image | default('ghcr.io/cirisai/cirislens-api:latest') }}
    container_name: cirislens-api
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://{{ lens_db_user | default('cirislens') }}:{{ lens_db_password }}@postgres:5432/{{ lens_db_name | default('cirislens') }}
      ENV: production
      # OAuth for admin UI
      GOOGLE_CLIENT_ID: {{ google_client_id | default('') }}
      GOOGLE_CLIENT_SECRET: {{ google_client_secret | default('') }}
      OAUTH_CALLBACK_URL: https://lens.{{ primary_domain }}/api/admin/auth/callback
      ALLOWED_DOMAIN: {{ lens_allowed_domain | default('ciris.ai') }}
      SESSION_SECRET: {{ lens_session_secret }}
      # Collection settings
      COLLECTION_INTERVAL_SECONDS: {{ lens_collection_interval | default(30) }}
      OTLP_COLLECTION_ENABLED: true
    volumes:
      - /var/log/ciris/lens:/app/logs
    ports:
      - "127.0.0.1:8200:8000"
    networks:
      - cirislens
      - ciris
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  cirislens:
    driver: bridge
  ciris:
    external: true
    name: postgres_ciris
