-- CIRISLens Database Initialization
-- Auto-generated by Ansible
-- Creates TimescaleDB hypertables with compression and retention policies

-- Create schema
CREATE SCHEMA IF NOT EXISTS cirislens;

-- Create Grafana database
CREATE DATABASE grafana;

-- Enable TimescaleDB extension
CREATE EXTENSION IF NOT EXISTS timescaledb;

-- =============================================================================
-- Service Tokens (for log ingestion authentication)
-- =============================================================================
CREATE TABLE IF NOT EXISTS cirislens.service_tokens (
    id SERIAL PRIMARY KEY,
    service_name VARCHAR(64) UNIQUE NOT NULL,
    token_hash VARCHAR(64) NOT NULL,
    description TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    created_by VARCHAR(255),
    last_used_at TIMESTAMPTZ,
    enabled BOOLEAN DEFAULT TRUE
);

-- =============================================================================
-- Service Logs (from Billing, Proxy, Manager)
-- =============================================================================
CREATE TABLE IF NOT EXISTS cirislens.service_logs (
    id BIGSERIAL,
    service_name VARCHAR(64) NOT NULL,
    server_id VARCHAR(64),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    level VARCHAR(16) NOT NULL,
    event VARCHAR(128),
    logger VARCHAR(128),
    message TEXT,
    request_id VARCHAR(64),
    trace_id VARCHAR(64),
    user_hash VARCHAR(16),
    attributes JSONB DEFAULT '{}'
);

-- Convert to hypertable (time-series optimized)
SELECT create_hypertable(
    'cirislens.service_logs',
    'timestamp',
    if_not_exists => TRUE,
    chunk_time_interval => INTERVAL '1 day'
);

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_service_logs_service
    ON cirislens.service_logs (service_name, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_service_logs_level
    ON cirislens.service_logs (level, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_service_logs_request_id
    ON cirislens.service_logs (request_id)
    WHERE request_id IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_service_logs_user_hash
    ON cirislens.service_logs (user_hash)
    WHERE user_hash IS NOT NULL;

-- =============================================================================
-- Agent Metrics (from CIRIS Agents via OTLP)
-- =============================================================================
CREATE TABLE IF NOT EXISTS cirislens.agent_metrics (
    id BIGSERIAL,
    agent_id VARCHAR(64) NOT NULL,
    agent_name VARCHAR(128),
    timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    metric_name VARCHAR(128) NOT NULL,
    metric_value DOUBLE PRECISION NOT NULL,
    labels JSONB DEFAULT '{}'
);

SELECT create_hypertable(
    'cirislens.agent_metrics',
    'timestamp',
    if_not_exists => TRUE,
    chunk_time_interval => INTERVAL '1 day'
);

CREATE INDEX IF NOT EXISTS idx_agent_metrics_agent
    ON cirislens.agent_metrics (agent_id, timestamp DESC);
CREATE INDEX IF NOT EXISTS idx_agent_metrics_name
    ON cirislens.agent_metrics (metric_name, timestamp DESC);

-- =============================================================================
-- Compression Policies (90% space savings after 7 days)
-- =============================================================================
ALTER TABLE cirislens.service_logs SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'service_name',
    timescaledb.compress_orderby = 'timestamp DESC'
);

ALTER TABLE cirislens.agent_metrics SET (
    timescaledb.compress,
    timescaledb.compress_segmentby = 'agent_id, metric_name',
    timescaledb.compress_orderby = 'timestamp DESC'
);

-- Compress chunks older than 7 days
SELECT add_compression_policy('cirislens.service_logs', INTERVAL '7 days', if_not_exists => TRUE);
SELECT add_compression_policy('cirislens.agent_metrics', INTERVAL '7 days', if_not_exists => TRUE);

-- =============================================================================
-- Retention Policies (automatic cleanup)
-- =============================================================================
-- Keep service logs for 14 days
SELECT add_retention_policy('cirislens.service_logs', INTERVAL '14 days', if_not_exists => TRUE);

-- Keep agent metrics for 30 days
SELECT add_retention_policy('cirislens.agent_metrics', INTERVAL '30 days', if_not_exists => TRUE);

-- =============================================================================
-- Continuous Aggregates (pre-computed hourly summaries)
-- =============================================================================
CREATE MATERIALIZED VIEW IF NOT EXISTS cirislens.service_logs_hourly
WITH (timescaledb.continuous) AS
SELECT
    time_bucket('1 hour', timestamp) AS bucket,
    service_name,
    level,
    COUNT(*) AS log_count
FROM cirislens.service_logs
GROUP BY bucket, service_name, level
WITH NO DATA;

-- Refresh hourly aggregates
SELECT add_continuous_aggregate_policy('cirislens.service_logs_hourly',
    start_offset => INTERVAL '2 hours',
    end_offset => INTERVAL '1 hour',
    schedule_interval => INTERVAL '1 hour',
    if_not_exists => TRUE
);

-- Keep hourly aggregates for 90 days
SELECT add_retention_policy('cirislens.service_logs_hourly', INTERVAL '90 days', if_not_exists => TRUE);

-- =============================================================================
-- Grant permissions
-- =============================================================================
GRANT USAGE ON SCHEMA cirislens TO {{ lens_db_user | default('cirislens') }};
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA cirislens TO {{ lens_db_user | default('cirislens') }};
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA cirislens TO {{ lens_db_user | default('cirislens') }};
