# PostgreSQL Configuration for Active/Active Bi-Directional Replication
# Auto-generated by Ansible for {{ node_name }} node
#
# Uses logical replication with last-write-wins conflict resolution

# Connection
listen_addresses = '*'
port = 5432
max_connections = {{ postgres_max_connections | default(100) }}

# Memory
shared_buffers = {{ postgres_shared_buffers | default('256MB') }}
effective_cache_size = {{ postgres_effective_cache_size | default('1GB') }}
work_mem = {{ postgres_work_mem | default('16MB') }}
maintenance_work_mem = {{ postgres_maintenance_work_mem | default('128MB') }}

# =============================================================================
# Logical Replication (required for bi-directional)
# =============================================================================
wal_level = logical
max_wal_senders = 10
max_replication_slots = 10
wal_keep_size = 256MB

# Track commit timestamps for last-write-wins conflict resolution
track_commit_timestamp = on

# Logical replication workers
max_logical_replication_workers = 4
max_sync_workers_per_subscription = 2

# =============================================================================
# Performance Tuning
# =============================================================================
synchronous_commit = local
hot_standby = on

# Checkpoints
checkpoint_completion_target = 0.9
checkpoint_timeout = 10min
max_wal_size = 1GB
min_wal_size = 256MB

# Planner
random_page_cost = 1.1
effective_io_concurrency = 200
default_statistics_target = 100

# =============================================================================
# Logging
# =============================================================================
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d.log'
log_statement = 'ddl'
log_min_duration_statement = 1000
log_replication_commands = on

# =============================================================================
# Extensions
# =============================================================================
shared_preload_libraries = ''
