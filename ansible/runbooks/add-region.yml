---
# Add Region Runbook
# Provision and configure a new region for CIRISBridge
# Based on multi-region DR best practices
# Reference: https://cloud.google.com/architecture/disaster-recovery
#
# Prerequisites:
#   1. Terraform resources provisioned for new region
#   2. DNS records created in Cloudflare
#   3. SSH access configured
#
# Usage:
#   ansible-playbook -i inventory/production.yml runbooks/add-region.yml -e "new_region=ap"
#
# Variables required in inventory:
#   - New host entry with region-specific variables
#   - postgres_password, jwt_secret_key, etc.

- name: "ADD REGION - Pre-flight Checks"
  hosts: localhost
  gather_facts: false
  vars:
    new_region: ""  # Required: e.g., "ap" for Asia-Pacific

  tasks:
    - name: Validate new_region is specified
      ansible.builtin.fail:
        msg: "You must specify new_region, e.g.: -e 'new_region=ap'"
      when: new_region | length == 0

    - name: Display add region plan
      ansible.builtin.debug:
        msg: |
          ============================================
          ADD REGION RUNBOOK
          ============================================
          New Region: {{ new_region }}

          This runbook will:
          1. Verify connectivity to new node
          2. Install base dependencies
          3. Deploy all CIRIS services
          4. Configure PostgreSQL replication
          5. Verify health endpoints
          6. Add to DNS rotation

          CHECKLIST before proceeding:
          [ ] Terraform apply completed for new region
          [ ] New host added to inventory/production.yml
          [ ] DNS records created in Cloudflare
          [ ] SSH key deployed to new node
          ============================================

- name: "ADD REGION - Phase 1: Base Setup"
  hosts: "{{ new_region | default('none') }}"
  gather_facts: true
  become: true

  tasks:
    - name: "BASE: Wait for SSH connectivity"
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: "BASE: Update apt cache"
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: "BASE: Install required packages"
      ansible.builtin.apt:
        name:
          - docker.io
          - docker-compose-v2
          - python3-pip
          - python3-docker
          - curl
          - jq
        state: present

    - name: "BASE: Start and enable Docker"
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true

    - name: "BASE: Create CIRIS directories"
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /opt/ciris
        - /opt/ciris/billing
        - /opt/ciris/proxy
        - /opt/ciris/caddy
        - /opt/ciris/postgres
        - /var/log/caddy

- name: "ADD REGION - Phase 2: Deploy Services"
  hosts: "{{ new_region | default('none') }}"
  gather_facts: false

  tasks:
    - name: "DEPLOY: Run main site playbook for new region"
      ansible.builtin.debug:
        msg: |
          Run the following command to deploy services:
          ansible-playbook -i inventory/production.yml playbooks/site.yml --limit {{ new_region }}

- name: "ADD REGION - Phase 3: Configure Replication"
  hosts: "{{ new_region | default('none') }}"
  gather_facts: false

  tasks:
    - name: "REPLICATION: Display replication setup instructions"
      ansible.builtin.debug:
        msg: |
          PostgreSQL Replication Setup:

          1. On PRIMARY node, add replication slot:
             SELECT pg_create_logical_replication_slot('{{ new_region }}_slot', 'pgoutput');

          2. On NEW node, create subscription:
             CREATE SUBSCRIPTION sub_from_primary
             CONNECTION 'host=<primary_ip> dbname=ciris_billing user=replicator password=<pass>'
             PUBLICATION ciris_pub_us;

          3. Verify replication:
             SELECT * FROM pg_stat_subscription;

- name: "ADD REGION - Phase 4: Verify Health"
  hosts: "{{ new_region | default('none') }}"
  gather_facts: false

  tasks:
    - name: "VERIFY: Wait for Billing API"
      ansible.builtin.uri:
        url: "http://localhost:8080/health"
        status_code: 200
      register: billing_health
      retries: 10
      delay: 5
      until: billing_health.status == 200

    - name: "VERIFY: Wait for Proxy API"
      ansible.builtin.uri:
        url: "http://localhost:4000/health/liveliness"
        status_code: 200
      register: proxy_health
      retries: 10
      delay: 5
      until: proxy_health.status == 200

    - name: "VERIFY: Test database connectivity"
      ansible.builtin.shell: |
        docker exec ciris-postgres psql -U postgres -d ciris_billing -c "SELECT 1;"
      register: db_check
      changed_when: false

    - name: "VERIFY: Display health status"
      ansible.builtin.debug:
        msg: |
          Health Check Results:
          - Billing API: {{ 'OK' if billing_health.status == 200 else 'FAILED' }}
          - Proxy API: {{ 'OK' if proxy_health.status == 200 else 'FAILED' }}
          - Database: {{ 'OK' if db_check.rc == 0 else 'FAILED' }}

- name: "ADD REGION - Phase 5: DNS Update"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: "DNS: Display DNS update instructions"
      ansible.builtin.debug:
        msg: |
          ============================================
          DNS UPDATE REQUIRED
          ============================================
          Add the following DNS records in Cloudflare:

          billing1.ciris-services-{{ new_region }}.ai -> <new_node_ip>
          proxy1.ciris-services-{{ new_region }}.ai -> <new_node_ip>

          Or update existing geo-DNS records to include
          the new region for automatic failover.
          ============================================

- name: "ADD REGION - Completion"
  hosts: localhost
  gather_facts: false

  tasks:
    - name: "COMPLETE: Display summary"
      ansible.builtin.debug:
        msg: |
          ============================================
          ADD REGION COMPLETE
          ============================================
          Region: {{ new_region }}

          Completed Steps:
          [x] Base setup (Docker, directories)
          [ ] Service deployment (run site.yml)
          [ ] PostgreSQL replication
          [ ] DNS update

          Post-deployment verification:
          1. Test external HTTPS endpoints
          2. Verify data replication
          3. Run test-proxy.yml against new region
          4. Monitor CIRISLens for errors

          To remove this region later:
          ansible-playbook runbooks/remove-region.yml -e "region={{ new_region }}"
          ============================================
