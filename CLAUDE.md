# CLAUDE.md - CIRISBridge

This file provides guidance for Claude Code when working on this repository.

## Project Context

CIRISBridge is the **orchestration layer** for CIRIS infrastructure. It deploys and manages:
- CIRISBilling (sibling repo)
- CIRISProxy (sibling repo)
- CIRISDNS (sibling repo)

**This is temporary infrastructure designed to be retired when Veilid becomes production-ready.**

## Key Files

| File | Purpose |
|------|---------|
| `terraform/main.tf` | Infrastructure provisioning (Vultr + Hetzner) |
| `terraform/variables.tf` | Configurable parameters |
| `terraform/outputs.tf` | Generated IPs, inventory |
| `ansible/playbooks/site.yml` | Full deployment playbook |
| `ansible/roles/*/tasks/main.yml` | Service-specific deployment |
| `scripts/deploy.sh` | Main deployment script |
| `FSD.md` | Locked specification (do not modify) |

## Build/Deploy Commands

```bash
# Deploy infrastructure only
./scripts/deploy.sh infra

# Deploy all services
./scripts/deploy.sh services

# Deploy specific service
./scripts/deploy.sh dns
./scripts/deploy.sh billing
./scripts/deploy.sh proxy

# Check health
./scripts/health-check.sh

# Backup database
POSTGRES_PASSWORD=xxx ./scripts/backup-db.sh
```

## Architecture Notes

### Multi-Region Setup
- **Primary (Vultr Chicago)**: PostgreSQL primary, handles writes
- **Secondary (Hetzner Germany)**: PostgreSQL replica, handles reads, failover target

### Service Dependencies
```
Caddy (TLS) -> CIRISBilling -> PostgreSQL
            -> CIRISProxy  -> CIRISBilling (credit checks)
Constellation (DNS) -> Redis
```

### Port Mapping
- 53/udp, 53/tcp: DNS (public)
- 80/tcp: HTTP (ACME challenges)
- 443/tcp: HTTPS (public)
- 5432/tcp: PostgreSQL (internal + replication)
- 6432/tcp: PgBouncer (internal)
- 8080/tcp: Billing API (internal, via Caddy)
- 4000/tcp: Proxy API (internal, via Caddy)

## Code Style

### Terraform
- Use `terraform fmt` before committing
- All sensitive values via variables (never hardcoded)
- Tag all resources with `cirisbridge` label

### Ansible
- Use YAML format consistently
- Template files end in `.j2`
- All secrets via Ansible Vault or environment variables
- Use `become: true` for privileged operations

### Shell Scripts
- Use `set -euo pipefail`
- Color output for visibility
- Always check prerequisites

## Common Tasks

### Adding a New Service
1. Create role in `ansible/roles/<service>/`
2. Add tasks, handlers, templates
3. Include in `playbooks/site.yml`
4. Add health check to `scripts/health-check.sh`

### Updating Service Configuration
1. Modify template in `ansible/roles/<service>/templates/`
2. Run `./scripts/deploy.sh <service>`
3. Verify with health check

### Scaling
- Vultr: Change `vultr_plan` in `terraform.tfvars`
- Hetzner: Change `hetzner_server_type` in `terraform.tfvars`
- Run `./scripts/deploy.sh infra`

## Gotchas

1. **Terraform state**: Don't lose `terraform.tfstate` - contains current infra mapping
2. **Ansible inventory**: Auto-generated by Terraform output - don't edit manually
3. **PostgreSQL replication**: Replica promotion is manual (see `failover-db.sh`)
4. **DNS propagation**: Changes can take up to 24 hours globally
5. **TLS certs**: Caddy auto-renews, but first deploy needs ports 80/443 open

## Testing Changes

### Local (without real providers)
```bash
cd terraform && terraform plan  # Dry run
cd ansible && ansible-playbook --check playbooks/site.yml  # Dry run
```

### Staging
No staging environment - test carefully in production with:
- `--limit` flag in Ansible to target single host
- Small changes with immediate rollback plan

## Security Considerations

- All secrets in `.env` (gitignored)
- SSH access restricted to admin IP only
- PostgreSQL not exposed publicly
- API services behind Caddy TLS
- fail2ban for SSH brute force protection

## Mission Alignment

Every change should consider:
1. **Cost**: Does this stay within $30/month budget?
2. **Simplicity**: Is this the simplest solution?
3. **Retirement**: Will this be easy to delete when Veilid is ready?
4. **Privacy**: Does this maintain ZDR compliance?

**Do not add features that would make retirement harder.**
